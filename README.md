# TinyIL.Mono
TinyIL is a lightweight weaver and IL parser for C# and Unity3d using Mono.Cecil. This allows a developer to access opcodes not otherwise exposed by the language or the accessible libraries by the target platform, as well as generate valid code that cannot be normally generated by the C# compiler. Like with most hand-written bytecode, this is best used for exposing functionality, reducing method size, and performing microoptimizations.

## How to Use
TinyIL scans compiled assemblies for attributes with the name `IntrinsicILAttribute`, with a constructor of format `IntrinsicIlAttribute(string)`. Upon finding these attributes on a method, it parses the attribute's string constructor argument into IL instructions and replaces the contents of the method with those instructions. Instructions are separated by newlines or by semicolons.

[IL Opcode Reference](https://learn.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes?view=net-8.0#fields)

### Examples

#### Generic enum-to-integral conversions
```csharp
[IntrinsicIL("ldarg.0; conv.i4; ret")] // non-boxing conversion
static public int ToInt<T>(T value) where T : struct, Enum
{
    // boxing conversion
    return Convert.ToInt32(value);
}
```

#### Clearing a block of memory
```csharp
[IntrinsicIL("ldarg.0; ldc.i4.0; ldarg.1; sizeof !!T; mul; unaligned. 1; initblk; ret")] // using initblk
static public unsafe void ClearBytes<T>(T* start, int length) where T : unmanaged
{
    // byte-by-byte clear
    byte* end = (byte*)(start + length);
    byte* ptr = (byte*)start;
    while(ptr < end) {
        *(ptr++) = 0;
    }
}
```

#### Accessing internal methods without reflection
Note: This requires compiling with `Allow unsafe code` checked. Otherwise, calls to this will result in a `MethodAccessException` being thrown
```csharp
public enum SceneLoadState
{
    NotLoaded,
    Loading,
    Loaded,
    Unloading
}

[IntrinsicIL("ldarga.s scene; call UnityEngine.SceneManagement.Scene::get_loadingState(); conv.i4; ret;")]
static private SceneLoadState GetLoadingState(Scene scene)
{  
    throw new NotImplementedException();  
}
```

## Notes
TinyIL currently supports a subset of IL features. This is supplemented by several macros and shortcuts.

### Type References
TinyIL supports a limited subset of IL's type reference grammar.

* Type references take the usual form of `Namespace.Type` or `Namespace.Type+NestedType`
* **Primitive types** can be referenced with these shortcuts
  * `int64`, `int32`, `int16`, `int8`
  * `uint64`, `uint32`, `uint16`, `uint8`
  * `float`, `double`
  * `string`, `char`
  * `bool`
  * `object`, `void`
* The method's **Declaring type** can be referenced with `[declaringType]`
* The method's **Parameter types** can be referenced with `[param parameterName]` or `[arg parameterName]`
* The method's **Variable types** can be referenced with `[var variableName]`
* **Generic type references** have limited support currently
  * Use `!!T` and the like for referencing generic types directly
  * If the type is available through a parameter, use a parameter type reference
* **Pointer type references** are currently unsupported

### Method References
Methods are referenced using the format `typeReference::methodName(typeReference, typeReference, ...)`. The current restrictions on generic type references still apply, and parameter-less generic methods are not currently supported.

### Field References
Fields are referenced using the format `typeReference::fieldName`.

### Variable Declarations
Variables can be declared using the format `#var name type`. For example, `#var tempSwap int32`.

### Labels
Labels can be declared using the format `labelName:`. For example, `EarlyExitLabel:`. This will point to the instruction on the following line.

All branching operations must be provided these label names as operands. In the case of `switch`, label names must be in a comma-separated list.

### Partially Supported Opcodes
* May not be supported by Unity's Il2Cpp transpiler
  * `arglist`
  * `mkrefany`
  * `refanytype`
  * `refanyval`

### Unsupported Opcodes

* `calli`
* `ldtoken`

### Roadmap
* IL patch file support, allowing IL to be injected from separate file
* Full support for type reference grammar
* Full support for parameter-less generic method references
* `ldtoken` support
* `calli` support